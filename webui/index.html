<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HiFiSampler Dashboard</title>
    <style>
        :root {
            --bg: #0f1117;
            --surface: #1a1d28;
            --surface2: #252836;
            --border: #2e3144;
            --text: #e4e6f0;
            --text-dim: #9ca0b4;
            --accent: #6c7bf0;
            --accent-hover: #8490f7;
            --green: #4ade80;
            --red: #f87171;
            --yellow: #fbbf24;
            --blue: #60a5fa;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* â”€â”€ Header â”€â”€ */
        .header {
            padding: 14px 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .header h1 {
            font-size: 18px;
            font-weight: 600;
            white-space: nowrap;
        }

        .header .status {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            color: var(--text-dim);
        }

        .header .status .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--green);
            animation: pulse 2s infinite;
        }

        .header .status .dot.off {
            background: var(--red);
            animation: none;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1
            }

            50% {
                opacity: .5
            }
        }

        .header .spacer {
            flex: 1;
        }

        .header .ver {
            font-size: 12px;
            color: var(--text-dim);
        }

        /* â”€â”€ Nav tabs â”€â”€ */
        .nav {
            display: flex;
            gap: 0;
            border-bottom: 1px solid var(--border);
            padding: 0 24px;
            overflow-x: auto;
        }

        .nav-t {
            padding: 11px 18px;
            cursor: pointer;
            font-size: 13px;
            color: var(--text-dim);
            border-bottom: 2px solid transparent;
            transition: all .2s;
            white-space: nowrap;
            user-select: none;
        }

        .nav-t.on {
            color: var(--accent);
            border-bottom-color: var(--accent);
        }

        .nav-t:hover:not(.on) {
            color: var(--text);
        }

        /* â”€â”€ Layout â”€â”€ */
        .main {
            padding: 20px 24px;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
        }

        .page {
            display: none;
            flex-direction: column;
            gap: 18px;
        }

        .page.on {
            display: flex;
        }

        /* â”€â”€ Cards â”€â”€ */
        .cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
        }

        .card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 16px;
            min-width: 0;
            overflow: hidden;
        }

        .card .lb {
            font-size: 11px;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: .5px;
        }

        .card .vl {
            font-size: 24px;
            font-weight: 700;
            margin-top: 6px;
            font-variant-numeric: tabular-nums;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .card .un {
            font-size: 13px;
            color: var(--text-dim);
            font-weight: 400;
        }

        /* â”€â”€ Section â”€â”€ */
        .sec {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 20px;
            overflow: hidden;
        }

        .sec h2 {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        /* â”€â”€ Time-series chart â”€â”€ */
        .chart-wrap {
            position: relative;
            height: 120px;
        }

        .chart-wrap canvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        /* (percentiles removed â€” now using canvas chart) */

        /* â”€â”€ Breakdown â”€â”€ */
        .bkd {
            display: flex;
            gap: 6px;
            margin-top: 12px;
        }

        .bkd .sg {
            height: 22px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 500;
            min-width: 48px;
        }

        .bkd .sg.f {
            background: #4f46e5;
        }

        .bkd .sg.s {
            background: #0891b2;
        }

        .bkd .sg.p {
            background: #059669;
        }

        .leg {
            display: flex;
            gap: 14px;
            margin-top: 6px;
            font-size: 11px;
            color: var(--text-dim);
            flex-wrap: wrap;
        }

        .leg i {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .leg d {
            width: 8px;
            height: 8px;
            border-radius: 2px;
            display: inline-block;
        }

        /* â”€â”€ Table â”€â”€ */
        .tw {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .rt {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        .rt th {
            text-align: left;
            padding: 6px 10px;
            color: var(--text-dim);
            font-weight: 500;
            border-bottom: 1px solid var(--border);
            white-space: nowrap;
        }

        .rt td {
            padding: 6px 10px;
            border-bottom: 1px solid var(--border);
            font-variant-numeric: tabular-nums;
            white-space: nowrap;
        }

        .rt td.args {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            white-space: pre-wrap;
            word-break: break-word;
            color: #d7dbef;
        }

        /* â”€â”€ Config form â”€â”€ */
        .cfg-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 10px;
        }

        .cfg-i {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            background: var(--surface2);
            border-radius: 6px;
            overflow: hidden;
            min-width: 0;
        }

        .cfg-i .k {
            color: var(--text-dim);
            font-size: 12px;
            white-space: nowrap;
            min-width: 110px;
            flex-shrink: 0;
        }

        .cfg-i input,
        .cfg-i select {
            flex: 1;
            min-width: 0;
            background: var(--bg);
            border: 1px solid var(--border);
            color: var(--text);
            padding: 5px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-family: inherit;
        }

        .cfg-i input:focus,
        .cfg-i select:focus {
            outline: none;
            border-color: var(--accent);
        }

        .cfg-hdr {
            grid-column: 1 / -1;
            font-size: 12px;
            color: var(--accent);
            font-weight: 600;
            margin-top: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* â”€â”€ Buttons â”€â”€ */
        .btn {
            padding: 7px 14px;
            border: 1px solid var(--border);
            background: var(--surface2);
            color: var(--text);
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all .2s;
            white-space: nowrap;
        }

        .btn:hover {
            background: var(--accent);
            border-color: var(--accent);
        }

        .btn-p {
            background: var(--accent);
            border-color: var(--accent);
        }

        .btn-p:hover {
            background: var(--accent-hover);
            border-color: var(--accent-hover);
        }

        .btn-ok {
            color: var(--green);
            border-color: #1e5c3a;
        }

        .btn-ok:hover {
            background: #1e5c3a;
            color: #fff;
        }

        .btn-no {
            color: var(--red);
            border-color: #5c2020;
        }

        .btn-no:hover {
            background: #5c2020;
            color: #fff;
        }

        /* â”€â”€ Setup wizard â”€â”€ */
        .wiz {
            max-width: 640px;
        }

        .step {
            margin-bottom: 20px;
            padding: 16px;
            background: var(--surface2);
            border-radius: 8px;
        }

        .step-h {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .step-n {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--accent);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            font-weight: 700;
            flex-shrink: 0;
        }

        .step-t {
            font-size: 14px;
            font-weight: 600;
        }

        .step-b {
            font-size: 13px;
            color: var(--text-dim);
            line-height: 1.7;
        }

        .step-b code {
            background: var(--bg);
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 12px;
        }

        .path-in {
            width: 100%;
            background: var(--bg);
            border: 1px solid var(--border);
            color: var(--text);
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 13px;
            margin-top: 8px;
            font-family: Consolas, monospace;
        }

        .path-in:focus {
            outline: none;
            border-color: var(--accent);
        }

        .smsg {
            padding: 10px 14px;
            border-radius: 6px;
            font-size: 13px;
            margin-top: 10px;
        }

        .smsg.ok {
            background: #132e1f;
            color: var(--green);
            border: 1px solid #1e5c3a;
        }

        .smsg.er {
            background: #2e1313;
            color: var(--red);
            border: 1px solid #5c2020;
        }

        .smsg.in {
            background: #131f2e;
            color: var(--blue);
            border: 1px solid #1e3a5c;
        }

        /* â”€â”€ Toast â”€â”€ */
        .toasts {
            position: fixed;
            top: 16px;
            right: 16px;
            z-index: 999;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .toast {
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 13px;
            animation: sIn .3s;
            box-shadow: 0 4px 12px rgba(0, 0, 0, .5);
        }

        .toast.s {
            background: #132e1f;
            color: var(--green);
            border: 1px solid #1e5c3a;
        }

        .toast.e {
            background: #2e1313;
            color: var(--red);
            border: 1px solid #5c2020;
        }

        @keyframes sIn {
            from {
                transform: translateX(100%);
                opacity: 0
            }

            to {
                transform: translateX(0);
                opacity: 1
            }
        }

        @media (max-width:640px) {
            .header {
                padding: 12px 16px
            }

            .nav {
                padding: 0 16px
            }

            .main {
                padding: 16px
            }

            .cards {
                grid-template-columns: repeat(2, 1fr)
            }

            .cfg-grid {
                grid-template-columns: 1fr
            }
        }
    </style>
</head>

<body>
    <div class="toasts" id="toasts"></div>
    <div class="header">
        <h1>ğŸµ HiFiSampler</h1>
        <div class="status">
            <div class="dot" id="sd"></div><span id="st" data-i18n="status.connecting">è¿æ¥ä¸­â€¦</span>
        </div>
        <div class="spacer"></div>
        <select id="langSel" class="btn" style="padding:6px 10px;">
            <option value="zh">ä¸­æ–‡</option>
            <option value="ja">æ—¥æœ¬èª</option>
            <option value="en">English</option>
            <option value="fr">FranÃ§ais</option>
            <option value="de">Deutsch</option>
            <option value="ru">Ğ ÑƒÑÑĞºĞ¸Ğ¹</option>
        </select>
        <button class="btn btn-no" id="exitBtn" onclick="exitApp()" data-i18n="common.exit">é€€å‡º</button>
        <div class="ver">v0.1.0</div>
    </div>
    <div class="nav">
        <div class="nav-t on" data-p="mon" data-i18n="nav.monitor">ğŸ“Š ç›‘æ§é¢æ¿</div>
        <div class="nav-t" data-p="cfg" data-i18n="nav.config">âš™ é…ç½®ç®¡ç†</div>
        <div class="nav-t" data-p="set" data-i18n="nav.setup">ğŸ”§ å®‰è£…å‘å¯¼</div>
    </div>
    <div class="main">
        <!-- â•â• Monitor â•â• -->
        <div class="page on" id="p-mon">
            <div class="cards">
                <div class="card">
                    <div class="lb" data-i18n="card.total_requests">æ€»è¯·æ±‚æ•°</div>
                    <div class="vl" id="c-req">0</div>
                </div>
                <div class="card">
                    <div class="lb" data-i18n="card.avg_latency">å¹³å‡å»¶è¿Ÿ</div>
                    <div class="vl" id="c-avg">0<span class="un">ms</span></div>
                </div>
                <div class="card">
                    <div class="lb" data-i18n="card.p95_latency">P95 å»¶è¿Ÿ</div>
                    <div class="vl" id="c-p95">0<span class="un">ms</span></div>
                </div>
                <div class="card">
                    <div class="lb" data-i18n="card.cache_hit">ç¼“å­˜å‘½ä¸­ç‡</div>
                    <div class="vl" id="c-hit">0<span class="un">%</span></div>
                </div>
                <div class="card">
                    <div class="lb" data-i18n="card.throughput">ååé‡</div>
                    <div class="vl" id="c-rps">0<span class="un">rps</span></div>
                </div>
                <div class="card">
                    <div class="lb" data-i18n="card.errors">é”™è¯¯</div>
                    <div class="vl" id="c-err">0</div>
                </div>
            </div>
            <div class="sec">
                <h2 data-i18n="mon.activity">ğŸ“ˆ è¯·æ±‚æ´»åŠ¨</h2>
                <div class="chart-wrap">
                    <canvas id="chart"></canvas>
                </div>
            </div>
            <div class="sec">
                <h2 data-i18n="mon.breakdown">ğŸ“Š è€—æ—¶åˆ†å¸ƒ (å¹³å‡)</h2>
                <div class="bkd" id="bkd"></div>
                <div class="leg">
                    <i>
                        <d style="background:#4f46e5"></d> <span data-i18n="mon.feature">ç‰¹å¾æå–</span>
                    </i>
                    <i>
                        <d style="background:#0891b2"></d> <span data-i18n="mon.synthesis">åˆæˆ</span>
                    </i>
                    <i>
                        <d style="background:#059669"></d> <span data-i18n="mon.postprocess">åå¤„ç†</span>
                    </i>
                </div>
            </div>
            <div class="sec">
                <h2><span data-i18n="mon.recent">ğŸ“‹ æœ€è¿‘è¯·æ±‚</span> <div style="flex:1"></div> <button class="btn" onclick="resetStats()" data-i18n="mon.clear_stats">æ¸…ç©ºç»Ÿè®¡</button></h2>
                <div class="tw">
                    <table class="rt">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th data-i18n="table.total_ms">æ€»è®¡(ms)</th>
                                <th data-i18n="table.feature">ç‰¹å¾</th>
                                <th data-i18n="table.synthesis">åˆæˆ</th>
                                <th data-i18n="table.postprocess">åå¤„ç†</th>
                                <th data-i18n="table.samples">é‡‡æ ·æ•°</th>
                                <th data-i18n="table.cache">ç¼“å­˜</th>
                            </tr>
                        </thead>
                        <tbody id="tbody"></tbody>
                    </table>
                </div>
            </div>

            <div class="sec">
                <h2><span data-i18n="dbg.title">ğŸ› Bridge è°ƒç”¨å‚æ•°</span> <div style="flex:1"></div> <button class="btn" onclick="resetDbg()" data-i18n="common.clear">æ¸…ç©º</button></h2>
                <p style="font-size:12px;color:var(--text-dim);margin-bottom:12px;" data-i18n="dbg.desc">æ˜¾ç¤ºæœ€è¿‘ 50 æ¬¡ bridge è°ƒç”¨ä¼ å…¥çš„åŸå§‹ CLI å‚æ•°ï¼ˆå³ POST / çš„ bodyï¼‰ï¼Œç”¨äºæ’æŸ¥ flags æ˜¯å¦çœŸçš„ä¼ åˆ°æœåŠ¡ç«¯ã€‚</p>
                <div class="tw">
                    <table class="rt">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th data-i18n="table.time">æ—¶é—´</th>
                                <th data-i18n="table.source">æ¥æº</th>
                                <th data-i18n="table.args">å‚æ•°</th>
                            </tr>
                        </thead>
                        <tbody id="dbgBody"></tbody>
                    </table>
                </div>
            </div>

            <div class="sec">
                <h2 data-i18n="flags.title">ğŸ· å¸¸ç”¨ Flags é€ŸæŸ¥</h2>
                <p style="font-size:12px;color:var(--text-dim);margin-bottom:12px;" data-i18n="flags.desc">ç”¨äºå¿«é€Ÿç¡®è®¤ OpenUTAU/UTAU ä¼ å‚æ˜¯å¦ç”Ÿæ•ˆã€‚å¯åœ¨ä¸Šæ–¹ã€ŒBridge è°ƒç”¨å‚æ•°ã€é‡Œç›´æ¥æ£€æŸ¥å®é™… flags å­—ç¬¦ä¸²ã€‚</p>
                <div class="tw">
                    <table class="rt">
                        <thead>
                            <tr>
                                <th>Flag</th>
                                <th data-i18n="flags.meaning">å«ä¹‰</th>
                                <th data-i18n="flags.range">èŒƒå›´ / ä¾‹å­</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td><code>He</code></td><td data-i18n="flags.he.meaning">åˆ‡æ¢å»¶é•¿ç­–ç•¥ï¼ˆä¸ config çš„ <code>processing.loop_mode</code> äº’æ–¥åè½¬ï¼‰</td><td data-i18n="flags.he.range">æ— æ•°å€¼ï¼Œä¾‹å¦‚ <code>He</code></td></tr>
                            <tr><td><code>HG</code></td><td data-i18n="flags.hg.meaning">Growl</td><td data-i18n="flags.hg.range"><code>0-100</code>ï¼Œä¾‹å¦‚ <code>HG50</code></td></tr>
                            <tr><td><code>Ht</code></td><td data-i18n="flags.ht.meaning">Tensionï¼ˆé¢‘è°±å€¾æ–œï¼‰</td><td data-i18n="flags.ht.range"><code>-100..100</code>ï¼Œä¾‹å¦‚ <code>Ht20</code></td></tr>
                            <tr><td><code>Hb</code></td><td data-i18n="flags.hb.meaning">Breathinessï¼ˆå™ªå£°æ¯”ä¾‹ï¼‰</td><td data-i18n="flags.hb.range"><code>0..500</code>ï¼Œä¾‹å¦‚ <code>Hb80</code></td></tr>
                            <tr><td><code>Hv</code></td><td data-i18n="flags.hv.meaning">Voicingï¼ˆè°æ³¢æ¯”ä¾‹ï¼‰</td><td data-i18n="flags.hv.range"><code>0..150</code>ï¼Œä¾‹å¦‚ <code>Hv120</code></td></tr>
                            <tr><td><code>g</code></td><td data-i18n="flags.g.meaning">Gender / Formant åç§»</td><td data-i18n="flags.g.range">æ•´æ•°ï¼Œä¾‹å¦‚ <code>g-10</code></td></tr>
                            <tr><td><code>A</code></td><td data-i18n="flags.a.meaning">æŒ‰éŸ³é«˜å˜åŒ–é€Ÿç‡è°ƒåˆ¶æŒ¯å¹…</td><td data-i18n="flags.a.range"><code>-100..100</code>ï¼Œä¾‹å¦‚ <code>A5</code></td></tr>
                            <tr><td><code>P</code></td><td data-i18n="flags.p.meaning">å“åº¦å½’ä¸€åŒ–å¼ºåº¦</td><td data-i18n="flags.p.range"><code>0..100</code>ï¼Œä¾‹å¦‚ <code>P80</code></td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <!-- â•â• Config â•â• -->
        <div class="page" id="p-cfg">
            <div class="sec">
                <h2><span data-i18n="cfg.title">âš™ è¿è¡Œæ—¶é…ç½®</span>
                    <div style="flex:1"></div>
                    <button class="btn btn-p" onclick="saveCfg()" data-i18n="cfg.save">ğŸ’¾ ä¿å­˜é…ç½®</button>
                    <button class="btn" onclick="loadCfg()" data-i18n="cfg.reset">ğŸ”„ é‡ç½®</button>
                </h2>
                <p style="font-size:12px;color:var(--text-dim);margin-bottom:14px;" data-i18n="cfg.desc">ä¿®æ”¹é…ç½®åç‚¹å‡»ã€Œä¿å­˜é…ç½®ã€å°†å†™å…¥
                    config.yamlã€‚éƒ¨åˆ†è®¾ç½®éœ€è¦é‡å¯æœåŠ¡æ‰èƒ½ç”Ÿæ•ˆã€‚</p>
                <div class="cfg-grid" id="cfgGrid"></div>
            </div>
        </div>
        <!-- â•â• Setup â•â• -->
        <div class="page" id="p-set">
            <div class="sec wiz">
                <h2 data-i18n="setup.title">ğŸ”§ OpenUTAU å®‰è£…å‘å¯¼</h2>
                <p style="font-size:13px;color:var(--text-dim);margin-bottom:16px;" data-i18n="setup.desc">å°† HiFiSampler æ¡¥æ¥ç¨‹åºå®‰è£…åˆ° OpenUTAUï¼Œåªéœ€ 3
                    æ­¥ã€‚</p>
                <div class="step">
                    <div class="step-h">
                        <div class="step-n">1</div>
                        <div class="step-t" data-i18n="setup.step1.title">é€‰æ‹© OpenUTAU Resamplers ç›®å½•</div>
                    </div>
                    <div class="step-b">
                        <p data-i18n="setup.step1.p1">æ‰“å¼€ OpenUTAU å®‰è£…ç›®å½•ï¼Œæ‰¾åˆ° <code>Resamplers</code> æ–‡ä»¶å¤¹ã€‚</p>
                        <p data-i18n="setup.step1.p2">é€šå¸¸ä½äºï¼š<code>C:\Users\ä½ çš„ç”¨æˆ·å\OpenUtau\Resamplers</code></p>
                        <p data-i18n="setup.step1.p3">æˆ– OpenUTAU ç¨‹åºæ‰€åœ¨ç›®å½•ä¸‹çš„ <code>Resamplers</code> æ–‡ä»¶å¤¹ã€‚</p>
                        <input class="path-in" id="ouPath" data-i18n-ph="setup.step1.placeholder" placeholder="è¾“å…¥æˆ–ç²˜è´´ Resamplers æ–‡ä»¶å¤¹çš„å®Œæ•´è·¯å¾„">
                    </div>
                </div>
                <div class="step">
                    <div class="step-h">
                        <div class="step-n">2</div>
                        <div class="step-t" data-i18n="setup.step2.title">å®‰è£…æ¡¥æ¥ç¨‹åº</div>
                    </div>
                    <div class="step-b">
                        <p data-i18n="setup.step2.p1">ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ï¼Œå°† <code>hifisampler.exe</code> å¤åˆ¶åˆ° Resamplers ç›®å½•ã€‚</p>
                        <button class="btn btn-ok" onclick="installBridge()" data-i18n="setup.step2.install">ğŸ“¦ å®‰è£…æ¡¥æ¥ç¨‹åº</button>
                        <div id="instSt"></div>
                    </div>
                </div>
                <div class="step">
                    <div class="step-h">
                        <div class="step-n">3</div>
                        <div class="step-t" data-i18n="setup.step3.title">é…ç½® OpenUTAU</div>
                    </div>
                    <div class="step-b">
                        <ol style="padding-left:18px;line-height:2">
                            <li data-i18n="setup.step3.li1"><strong>é‡å¯ OpenUTAU</strong></li>
                            <li data-i18n="setup.step3.li2">åˆ‡æ¢åˆ° <strong>Classic æ¨¡å¼</strong></li>
                            <li data-i18n="setup.step3.li3">ç‚¹å‡»å³ä¸Šè§’ <strong>ğŸ”§ æ‰³æ‰‹æŒ‰é’®</strong></li>
                            <li data-i18n="setup.step3.li4">åœ¨ Resampler ä¸‹æ‹‰åˆ—è¡¨ä¸­é€‰æ‹© <code>hifisampler.exe</code></li>
                            <li data-i18n="setup.step3.li5">å®Œæˆï¼äº«å— HiFi éŸ³è´¨çš„ UTAU åˆæˆ ğŸ‰</li>
                        </ol>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        const B = location.origin;
        const I18N = {
            zh: {
                'status.connecting': 'è¿æ¥ä¸­â€¦', 'status.online': 'åœ¨çº¿', 'status.offline': 'ç¦»çº¿',
                'common.exit': 'é€€å‡º', 'common.clear': 'æ¸…ç©º', 'common.on': 'å¼€å¯', 'common.off': 'å…³é—­',
                'nav.monitor': 'ğŸ“Š ç›‘æ§é¢æ¿', 'nav.config': 'âš™ é…ç½®ç®¡ç†', 'nav.setup': 'ğŸ”§ å®‰è£…å‘å¯¼',
                'card.total_requests': 'æ€»è¯·æ±‚æ•°', 'card.avg_latency': 'å¹³å‡å»¶è¿Ÿ', 'card.p95_latency': 'P95 å»¶è¿Ÿ', 'card.cache_hit': 'ç¼“å­˜å‘½ä¸­ç‡', 'card.throughput': 'ååé‡', 'card.errors': 'é”™è¯¯',
                'mon.activity': 'ğŸ“ˆ è¯·æ±‚æ´»åŠ¨', 'mon.breakdown': 'ğŸ“Š è€—æ—¶åˆ†å¸ƒ (å¹³å‡)', 'mon.feature': 'ç‰¹å¾æå–', 'mon.synthesis': 'åˆæˆ', 'mon.postprocess': 'åå¤„ç†', 'mon.recent': 'ğŸ“‹ æœ€è¿‘è¯·æ±‚', 'mon.clear_stats': 'æ¸…ç©ºç»Ÿè®¡',
                'table.total_ms': 'æ€»è®¡(ms)', 'table.feature': 'ç‰¹å¾', 'table.synthesis': 'åˆæˆ', 'table.postprocess': 'åå¤„ç†', 'table.samples': 'é‡‡æ ·æ•°', 'table.cache': 'ç¼“å­˜', 'table.time': 'æ—¶é—´', 'table.source': 'æ¥æº', 'table.args': 'å‚æ•°',
                'dbg.title': 'ğŸ› Bridge è°ƒç”¨å‚æ•°', 'dbg.desc': 'æ˜¾ç¤ºæœ€è¿‘ 50 æ¬¡ bridge è°ƒç”¨ä¼ å…¥çš„åŸå§‹ CLI å‚æ•°ï¼ˆå³ POST / çš„ bodyï¼‰ï¼Œç”¨äºæ’æŸ¥ flags æ˜¯å¦çœŸçš„ä¼ åˆ°æœåŠ¡ç«¯ã€‚',
                'flags.title': 'ğŸ· å¸¸ç”¨ Flags é€ŸæŸ¥', 'flags.desc': 'ç”¨äºå¿«é€Ÿç¡®è®¤ OpenUTAU/UTAU ä¼ å‚æ˜¯å¦ç”Ÿæ•ˆã€‚å¯åœ¨ä¸Šæ–¹ã€ŒBridge è°ƒç”¨å‚æ•°ã€é‡Œç›´æ¥æ£€æŸ¥å®é™… flags å­—ç¬¦ä¸²ã€‚', 'flags.meaning': 'å«ä¹‰', 'flags.range': 'èŒƒå›´ / ä¾‹å­',
                'flags.he.meaning': 'åˆ‡æ¢å»¶é•¿ç­–ç•¥ï¼ˆä¸ config çš„ <code>processing.loop_mode</code> äº’æ–¥åè½¬ï¼‰', 'flags.he.range': 'æ— æ•°å€¼ï¼Œä¾‹å¦‚ <code>He</code>',
                'flags.hg.meaning': 'Growl', 'flags.hg.range': '<code>0-100</code>ï¼Œä¾‹å¦‚ <code>HG50</code>',
                'flags.ht.meaning': 'Tensionï¼ˆé¢‘è°±å€¾æ–œï¼‰', 'flags.ht.range': '<code>-100..100</code>ï¼Œä¾‹å¦‚ <code>Ht20</code>',
                'flags.hb.meaning': 'Breathinessï¼ˆå™ªå£°æ¯”ä¾‹ï¼‰', 'flags.hb.range': '<code>0..500</code>ï¼Œä¾‹å¦‚ <code>Hb80</code>',
                'flags.hv.meaning': 'Voicingï¼ˆè°æ³¢æ¯”ä¾‹ï¼‰', 'flags.hv.range': '<code>0..150</code>ï¼Œä¾‹å¦‚ <code>Hv120</code>',
                'flags.g.meaning': 'Gender / Formant åç§»', 'flags.g.range': 'æ•´æ•°ï¼Œä¾‹å¦‚ <code>g-10</code>',
                'flags.a.meaning': 'æŒ‰éŸ³é«˜å˜åŒ–é€Ÿç‡è°ƒåˆ¶æŒ¯å¹…', 'flags.a.range': '<code>-100..100</code>ï¼Œä¾‹å¦‚ <code>A5</code>',
                'flags.p.meaning': 'å“åº¦å½’ä¸€åŒ–å¼ºåº¦', 'flags.p.range': '<code>0..100</code>ï¼Œä¾‹å¦‚ <code>P80</code>',
                'cfg.title': 'âš™ è¿è¡Œæ—¶é…ç½®', 'cfg.save': 'ğŸ’¾ ä¿å­˜é…ç½®', 'cfg.reset': 'ğŸ”„ é‡ç½®', 'cfg.desc': 'ä¿®æ”¹é…ç½®åç‚¹å‡»ã€Œä¿å­˜é…ç½®ã€å°†å†™å…¥ config.yamlã€‚éƒ¨åˆ†è®¾ç½®éœ€è¦é‡å¯æœåŠ¡æ‰èƒ½ç”Ÿæ•ˆã€‚',
                'setup.title': 'ğŸ”§ OpenUTAU å®‰è£…å‘å¯¼', 'setup.desc': 'å°† HiFiSampler æ¡¥æ¥ç¨‹åºå®‰è£…åˆ° OpenUTAUï¼Œåªéœ€ 3 æ­¥ã€‚',
                'setup.step1.title': 'é€‰æ‹© OpenUTAU Resamplers ç›®å½•', 'setup.step1.p1': 'æ‰“å¼€ OpenUTAU å®‰è£…ç›®å½•ï¼Œæ‰¾åˆ° <code>Resamplers</code> æ–‡ä»¶å¤¹ã€‚', 'setup.step1.p2': 'é€šå¸¸ä½äºï¼š<code>C:\\Users\\ä½ çš„ç”¨æˆ·å\\OpenUtau\\Resamplers</code>', 'setup.step1.p3': 'æˆ– OpenUTAU ç¨‹åºæ‰€åœ¨ç›®å½•ä¸‹çš„ <code>Resamplers</code> æ–‡ä»¶å¤¹ã€‚', 'setup.step1.placeholder': 'è¾“å…¥æˆ–ç²˜è´´ Resamplers æ–‡ä»¶å¤¹çš„å®Œæ•´è·¯å¾„',
                'setup.step2.title': 'å®‰è£…æ¡¥æ¥ç¨‹åº', 'setup.step2.p1': 'ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ï¼Œå°† <code>hifisampler.exe</code> å¤åˆ¶åˆ° Resamplers ç›®å½•ã€‚', 'setup.step2.install': 'ğŸ“¦ å®‰è£…æ¡¥æ¥ç¨‹åº',
                'setup.step3.title': 'é…ç½® OpenUTAU', 'setup.step3.li1': '<strong>é‡å¯ OpenUTAU</strong>', 'setup.step3.li2': 'åˆ‡æ¢åˆ° <strong>Classic æ¨¡å¼</strong>', 'setup.step3.li3': 'ç‚¹å‡»å³ä¸Šè§’ <strong>ğŸ”§ æ‰³æ‰‹æŒ‰é’®</strong>', 'setup.step3.li4': 'åœ¨ Resampler ä¸‹æ‹‰åˆ—è¡¨ä¸­é€‰æ‹© <code>hifisampler.exe</code>', 'setup.step3.li5': 'å®Œæˆï¼äº«å— HiFi éŸ³è´¨çš„ UTAU åˆæˆ ğŸ‰',
                'misc.no_records': 'æš‚æ— è®°å½•', 'misc.no_data': 'æš‚æ— æ•°æ®', 'misc.no_requests': 'æš‚æ— è¯·æ±‚', 'misc.waiting_data': 'ç­‰å¾…æ•°æ®â€¦', 'misc.shutting_down': 'é€€å‡ºä¸­...',
                'toast.stats_cleared': 'ç»Ÿè®¡å·²æ¸…ç©º', 'toast.debug_cleared': 'è°ƒè¯•è®°å½•å·²æ¸…ç©º', 'toast.clear_failed': 'æ¸…ç©ºå¤±è´¥', 'toast.load_cfg_failed': 'åŠ è½½é…ç½®å¤±è´¥', 'toast.device_fallback': 'å½“å‰è®¾å¤‡åœ¨æ­¤å‘è¡Œç‰ˆä¸å¯ç”¨ï¼Œå·²è‡ªåŠ¨å›é€€ä¸º auto', 'toast.cfg_saved': 'é…ç½®å·²ä¿å­˜ï¼éƒ¨åˆ†è®¾ç½®é‡å¯åç”Ÿæ•ˆ', 'toast.save_failed': 'ä¿å­˜å¤±è´¥: ', 'toast.enter_path': 'è¯·å…ˆè¾“å…¥ Resamplers ç›®å½•è·¯å¾„', 'toast.install_ok': 'æ¡¥æ¥ç¨‹åºå®‰è£…æˆåŠŸï¼', 'toast.install_failed': 'å®‰è£…å¤±è´¥', 'toast.connect_failed': 'è¿æ¥æœåŠ¡å™¨å¤±è´¥', 'toast.installing': 'æ­£åœ¨å®‰è£…â€¦',
                'cfg.group.audio': 'éŸ³é¢‘', 'cfg.group.model': 'æ¨¡å‹', 'cfg.group.processing': 'å¤„ç†', 'cfg.group.performance': 'æ€§èƒ½', 'cfg.group.server': 'æœåŠ¡å™¨', 'cfg.group.other': 'å…¶ä»–',
                'cfg.sample_rate': 'é‡‡æ ·ç‡', 'cfg.n_fft': 'FFT å¤§å°', 'cfg.win_size': 'çª—å£å¤§å°', 'cfg.hop_size': 'Hop å¤§å°', 'cfg.hop_size_interp': 'æ’å€¼ Hop', 'cfg.num_mels': 'Mel é€šé“æ•°', 'cfg.fmin': 'æœ€ä½é¢‘ç‡', 'cfg.fmax': 'æœ€é«˜é¢‘ç‡', 'cfg.pad_frames': 'å¡«å……å¸§æ•°', 'cfg.vocoder_model': 'Vocoder æ¨¡å‹è·¯å¾„', 'cfg.vocoder_model_type': 'æ¨¡å‹ç±»å‹', 'cfg.vocoder_use_fp16': 'ä½¿ç”¨é‡åŒ–å£°ç å™¨ (FP16)', 'cfg.hnsep_model': 'HN-SEP æ¨¡å‹è·¯å¾„', 'cfg.wave_norm': 'æ³¢å½¢å½’ä¸€åŒ–', 'cfg.wave_norm_clip': 'è£å‰ªé™éŸ³', 'cfg.loop_mode': 'å¾ªç¯æ¨¡å¼(Heå¯åè½¬)', 'cfg.peak_limit': 'å³°å€¼é™åˆ¶', 'cfg.num_threads': 'æ¨ç†çº¿ç¨‹æ•°', 'cfg.device': 'è®¾å¤‡', 'cfg.device_id': 'DirectML è®¾å¤‡', 'cfg.host': 'æœåŠ¡åœ°å€', 'cfg.port': 'æœåŠ¡ç«¯å£', 'cfg.device_unavailable': 'å½“å‰å€¼ä¸å¯ç”¨'
            },
            en: {
                'status.connecting': 'Connecting...', 'status.online': 'Online', 'status.offline': 'Offline',
                'common.exit': 'Exit', 'common.clear': 'Clear', 'common.on': 'On', 'common.off': 'Off',
                'nav.monitor': 'ğŸ“Š Monitor', 'nav.config': 'âš™ Config', 'nav.setup': 'ğŸ”§ Setup',
                'card.total_requests': 'Total Requests', 'card.avg_latency': 'Avg Latency', 'card.p95_latency': 'P95 Latency', 'card.cache_hit': 'Cache Hit Rate', 'card.throughput': 'Throughput', 'card.errors': 'Errors',
                'mon.activity': 'ğŸ“ˆ Request Activity', 'mon.breakdown': 'ğŸ“Š Time Breakdown (Avg)', 'mon.feature': 'Feature', 'mon.synthesis': 'Synthesis', 'mon.postprocess': 'Postprocess', 'mon.recent': 'ğŸ“‹ Recent Requests', 'mon.clear_stats': 'Clear Stats',
                'table.total_ms': 'Total(ms)', 'table.feature': 'Feature', 'table.synthesis': 'Synthesis', 'table.postprocess': 'Postprocess', 'table.samples': 'Samples', 'table.cache': 'Cache', 'table.time': 'Time', 'table.source': 'Source', 'table.args': 'Args',
                'dbg.title': 'ğŸ› Bridge CLI Args', 'dbg.desc': 'Shows latest 50 raw bridge CLI payloads (POST / body) to verify flags are actually passed to server.',
                'flags.title': 'ğŸ· Flag Quick Reference', 'flags.desc': 'Use this to verify OpenUTAU/UTAU flags. You can also inspect the exact flag string in Bridge CLI Args above.', 'flags.meaning': 'Meaning', 'flags.range': 'Range / Example',
                'flags.he.meaning': 'Toggle extension strategy (XOR with config <code>processing.loop_mode</code>)', 'flags.he.range': 'No value, e.g. <code>He</code>', 'flags.hg.meaning': 'Growl', 'flags.hg.range': '<code>0-100</code>, e.g. <code>HG50</code>', 'flags.ht.meaning': 'Tension (spectral tilt)', 'flags.ht.range': '<code>-100..100</code>, e.g. <code>Ht20</code>', 'flags.hb.meaning': 'Breathiness (noise ratio)', 'flags.hb.range': '<code>0..500</code>, e.g. <code>Hb80</code>', 'flags.hv.meaning': 'Voicing (harmonic ratio)', 'flags.hv.range': '<code>0..150</code>, e.g. <code>Hv120</code>', 'flags.g.meaning': 'Gender / formant shift', 'flags.g.range': 'Integer, e.g. <code>g-10</code>', 'flags.a.meaning': 'Amplitude modulation by pitch-rate', 'flags.a.range': '<code>-100..100</code>, e.g. <code>A5</code>', 'flags.p.meaning': 'Loudness normalization strength', 'flags.p.range': '<code>0..100</code>, e.g. <code>P80</code>',
                'cfg.title': 'âš™ Runtime Config', 'cfg.save': 'ğŸ’¾ Save', 'cfg.reset': 'ğŸ”„ Reset', 'cfg.desc': 'Click Save to write config.yaml. Some settings require restart.',
                'setup.title': 'ğŸ”§ OpenUTAU Setup Wizard', 'setup.desc': 'Install HiFiSampler bridge to OpenUTAU in 3 steps.',
                'setup.step1.title': 'Choose OpenUTAU Resamplers folder', 'setup.step1.p1': 'Open OpenUTAU install directory and locate <code>Resamplers</code>.', 'setup.step1.p2': 'Usually: <code>C:\\Users\\YourName\\OpenUtau\\Resamplers</code>', 'setup.step1.p3': 'Or under OpenUTAU program folder.', 'setup.step1.placeholder': 'Enter or paste full Resamplers folder path',
                'setup.step2.title': 'Install bridge', 'setup.step2.p1': 'Click below to copy <code>hifisampler.exe</code> into Resamplers.', 'setup.step2.install': 'ğŸ“¦ Install Bridge',
                'setup.step3.title': 'Configure OpenUTAU', 'setup.step3.li1': '<strong>Restart OpenUTAU</strong>', 'setup.step3.li2': 'Switch to <strong>Classic mode</strong>', 'setup.step3.li3': 'Click the top-right <strong>ğŸ”§ wrench</strong>', 'setup.step3.li4': 'Select <code>hifisampler.exe</code> in Resampler dropdown', 'setup.step3.li5': 'Done! Enjoy HiFi UTAU synthesis ğŸ‰',
                'misc.no_records': 'No records', 'misc.no_data': 'No data', 'misc.no_requests': 'No requests', 'misc.waiting_data': 'Waiting for data...', 'misc.shutting_down': 'Shutting down...',
                'toast.stats_cleared': 'Stats cleared', 'toast.debug_cleared': 'Debug records cleared', 'toast.clear_failed': 'Clear failed', 'toast.load_cfg_failed': 'Failed to load config', 'toast.device_fallback': 'Selected device is unavailable, fallback to auto', 'toast.cfg_saved': 'Config saved. Some changes require restart', 'toast.save_failed': 'Save failed: ', 'toast.enter_path': 'Please enter Resamplers path first', 'toast.install_ok': 'Bridge installed successfully', 'toast.install_failed': 'Install failed', 'toast.connect_failed': 'Server connection failed', 'toast.installing': 'Installing...',
                'cfg.group.audio': 'Audio', 'cfg.group.model': 'Model', 'cfg.group.processing': 'Processing', 'cfg.group.performance': 'Performance', 'cfg.group.server': 'Server', 'cfg.group.other': 'Other',
                'cfg.sample_rate': 'Sample Rate', 'cfg.n_fft': 'FFT Size', 'cfg.win_size': 'Window Size', 'cfg.hop_size': 'Hop Size', 'cfg.hop_size_interp': 'Interp Hop', 'cfg.num_mels': 'Mel Bins', 'cfg.fmin': 'Min Freq', 'cfg.fmax': 'Max Freq', 'cfg.pad_frames': 'Pad Frames', 'cfg.vocoder_model': 'Vocoder Model Path', 'cfg.vocoder_model_type': 'Model Type', 'cfg.vocoder_use_fp16': 'Use quantized vocoder (FP16)', 'cfg.hnsep_model': 'HN-SEP Model Path', 'cfg.wave_norm': 'Wave Norm', 'cfg.wave_norm_clip': 'Clip Silence', 'cfg.loop_mode': 'Loop Mode (He invert)', 'cfg.peak_limit': 'Peak Limit', 'cfg.num_threads': 'Inference Threads', 'cfg.device': 'Device', 'cfg.device_id': 'DirectML Device', 'cfg.host': 'Host', 'cfg.port': 'Port', 'cfg.device_unavailable': 'Current value unavailable'
            }
        };
        I18N.ja = { ...I18N.en, 'common.exit': 'çµ‚äº†', 'common.clear': 'ã‚¯ãƒªã‚¢', 'status.online': 'ã‚ªãƒ³ãƒ©ã‚¤ãƒ³', 'status.offline': 'ã‚ªãƒ•ãƒ©ã‚¤ãƒ³', 'status.connecting': 'æ¥ç¶šä¸­...' };
        I18N.fr = { ...I18N.en, 'common.exit': 'Quitter', 'common.clear': 'Effacer', 'status.online': 'En ligne', 'status.offline': 'Hors ligne', 'status.connecting': 'Connexion...' };
        I18N.de = { ...I18N.en, 'common.exit': 'Beenden', 'common.clear': 'Leeren', 'status.online': 'Online', 'status.offline': 'Offline', 'status.connecting': 'Verbinden...' };
        I18N.ru = { ...I18N.en, 'common.exit': 'Ğ’Ñ‹Ñ…Ğ¾Ğ´', 'common.clear': 'ĞÑ‡Ğ¸ÑÑ‚Ğ¸Ñ‚ÑŒ', 'status.online': 'ĞĞ½Ğ»Ğ°Ğ¹Ğ½', 'status.offline': 'ĞÑ„Ñ„Ğ»Ğ°Ğ¹Ğ½', 'status.connecting': 'ĞŸĞ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ...' };
        const SUPPORTED_LANGS = ['zh', 'ja', 'en', 'fr', 'de', 'ru'];
        let LANG = localStorage.getItem('hifisampler.lang') || 'zh';
        if (!SUPPORTED_LANGS.includes(LANG)) LANG = 'zh';
        function t(k) { return (I18N[LANG] && I18N[LANG][k]) || (I18N.en && I18N.en[k]) || k; }
        function applyI18n() {
            document.documentElement.lang = LANG;
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                el.innerHTML = t(key);
            });
            document.querySelectorAll('[data-i18n-ph]').forEach(el => {
                const key = el.getAttribute('data-i18n-ph');
                el.setAttribute('placeholder', t(key));
            });
            const ls = document.getElementById('langSel');
            if (ls) ls.value = LANG;
            renderCfg();
        }
        let curCfg = {};
        let caps = {
            available_devices: ['auto', 'cpu'],
            available_eps_raw: [],
            dml_adapters: [],
        };
        /* â”€â”€ tabs â”€â”€ */
        document.querySelectorAll('.nav-t').forEach(t => t.onclick = () => {
            document.querySelectorAll('.nav-t').forEach(x => x.classList.remove('on'));
            document.querySelectorAll('.page').forEach(x => x.classList.remove('on'));
            t.classList.add('on');
            document.getElementById('p-' + t.dataset.p).classList.add('on');
        });
        /* â”€â”€ toast â”€â”€ */
        function toast(m, ok = true) {
            const c = document.getElementById('toasts'), d = document.createElement('div');
            d.className = 'toast ' + (ok ? 's' : 'e'); d.textContent = m; c.appendChild(d);
            setTimeout(() => { d.style.opacity = '0'; setTimeout(() => d.remove(), 300); }, 3000);
        }
        /* â•â• Monitor â•â• */
        async function poll() {
            try {
                const r = await fetch(B + '/stats');
                if (!r.ok) throw 0;
                const d = await r.json();
                upMon(d); setOn(true);
            } catch { setOn(false); }
        }

        async function pollDbg() {
            try {
                const r = await fetch(B + '/debug/bridge-calls', { cache: 'no-store' });
                if (!r.ok) throw 0;
                const d = await r.json();
                upDbg(d);
            } catch {
                // ignore
            }
        }
        function setOn(v) { document.getElementById('sd').className = v ? 'dot' : 'dot off'; document.getElementById('st').textContent = v ? t('status.online') : t('status.offline'); }
        function $(id) { return document.getElementById(id); }

        function fmtTs(ms) {
            const dt = new Date(ms);
            const pad = (n) => String(n).padStart(2, '0');
            return pad(dt.getHours()) + ':' + pad(dt.getMinutes()) + ':' + pad(dt.getSeconds());
        }

        function esc(s) {
            return (s ?? '').toString()
                .replaceAll('&', '&amp;')
                .replaceAll('<', '&lt;')
                .replaceAll('>', '&gt;')
                .replaceAll('"', '&quot;')
                .replaceAll("'", '&#39;');
        }

        function upDbg(d) {
            const tb = $('dbgBody');
            if (!tb) return;
            if (!d || !d.length) {
                tb.innerHTML = `<tr><td colspan="4" style="color:var(--text-dim);text-align:center">${t('misc.no_records')}</td></tr>`;
                return;
            }
            tb.innerHTML = d.map((r, i) => {
                const args = esc(r.args || '');
                const remote = esc(r.remote || '');
                const ts = fmtTs(r.unix_ms || 0);
                return `<tr><td>${i + 1}</td><td>${ts}</td><td>${remote}</td><td class="args">${args}</td></tr>`;
            }).join('');
        }
        /* â”€â”€ time-series data â”€â”€ */
        const TS_MAX = 150; // 150 points Ã— 0.2s = 30s window
        const tsData = [];  // [{t: Date, active: number}]
        function upMon(d) {
            $('c-req').textContent = d.total_requests;
            $('c-avg').innerHTML = d.avg_total_ms.toFixed(1) + '<span class="un">ms</span>';
            $('c-p95').innerHTML = d.p95_total_ms.toFixed(1) + '<span class="un">ms</span>';
            $('c-hit').innerHTML = (d.cache_hit_rate * 100).toFixed(0) + '<span class="un">%</span>';
            $('c-rps').innerHTML = d.throughput_rps.toFixed(1) + '<span class="un">rps</span>';
            $('c-err').textContent = d.total_errors;
            /* time-series: record active requests */
            tsData.push({ t: new Date(), active: d.active_requests || 0 });
            while (tsData.length > TS_MAX) tsData.shift();
            drawChart();
            /* breakdown */
            const bd = $('bkd'), totalMs = d.avg_feature_ms + d.avg_synthesis_ms + d.avg_postprocess_ms;
            if (totalMs <= 0) { bd.innerHTML = `<div style="color:var(--text-dim);font-size:12px">${t('misc.no_data')}</div>`; }
            else { const fp = (d.avg_feature_ms / totalMs * 100).toFixed(0), sp = (d.avg_synthesis_ms / totalMs * 100).toFixed(0), pp = (d.avg_postprocess_ms / totalMs * 100).toFixed(0); bd.innerHTML = `<div class="sg f" style="flex:${fp}">${d.avg_feature_ms.toFixed(0)}ms (${fp}%)</div><div class="sg s" style="flex:${sp}">${d.avg_synthesis_ms.toFixed(0)}ms (${sp}%)</div><div class="sg p" style="flex:${pp}">${d.avg_postprocess_ms.toFixed(0)}ms (${pp}%)</div>`; }
            /* table */
            const rc = d.recent, tb = $('tbody');
            if (!rc || !rc.length) { tb.innerHTML = `<tr><td colspan="7" style="color:var(--text-dim);text-align:center">${t('misc.no_requests')}</td></tr>`; }
            else { tb.innerHTML = rc.map((r, i) => `<tr><td>${i + 1}</td><td>${r.total_ms.toFixed(1)}</td><td>${r.feature_ms.toFixed(1)}</td><td>${r.synthesis_ms.toFixed(1)}</td><td>${r.postprocess_ms.toFixed(1)}</td><td>${r.output_samples}</td><td>${r.cache_hit ? 'âœ“' : 'âœ—'}</td></tr>`).join(''); }
        }
        /* â”€â”€ canvas chart â”€â”€ */
        function drawChart() {
            const canvas = $('chart');
            const rect = canvas.parentElement.getBoundingClientRect();
            const dpr = window.devicePixelRatio || 1;
            const W = rect.width, H = rect.height;
            canvas.width = W * dpr; canvas.height = H * dpr;
            const ctx = canvas.getContext('2d');
            ctx.scale(dpr, dpr);
            const pad = { l: 36, r: 12, t: 12, b: 24 };
            const cw = W - pad.l - pad.r, ch = H - pad.t - pad.b;
            ctx.clearRect(0, 0, W, H);
            if (tsData.length < 2) {
                ctx.fillStyle = '#9ca0b4'; ctx.font = '12px sans-serif'; ctx.textAlign = 'center';
                ctx.fillText(t('misc.waiting_data'), W / 2, H / 2);
                return;
            }
            const maxY = Math.max(1, ...tsData.map(p => p.active));
            const yTicks = Math.min(maxY, 5);
            // grid & Y labels
            ctx.strokeStyle = '#2e3144'; ctx.lineWidth = 1;
            ctx.fillStyle = '#9ca0b4'; ctx.font = '10px sans-serif'; ctx.textAlign = 'right';
            for (let i = 0; i <= yTicks; i++) {
                const v = Math.round(maxY / yTicks * i);
                const y = pad.t + ch - (v / maxY) * ch;
                ctx.beginPath(); ctx.moveTo(pad.l, y); ctx.lineTo(pad.l + cw, y); ctx.stroke();
                ctx.fillText(v, pad.l - 4, y + 3);
            }
            // X labels (~5)
            ctx.textAlign = 'center';
            const n = tsData.length, xStep = Math.max(1, Math.floor(n / 5));
            for (let i = 0; i < n; i += xStep) {
                const x = pad.l + (i / (n - 1)) * cw;
                const tt = tsData[i].t;
                const lbl = tt.getHours().toString().padStart(2, '0') + ':' + tt.getMinutes().toString().padStart(2, '0') + ':' + tt.getSeconds().toString().padStart(2, '0');
                ctx.fillText(lbl, x, H - 4);
            }
            // area fill
            ctx.beginPath(); ctx.moveTo(pad.l, pad.t + ch);
            for (let i = 0; i < n; i++) { ctx.lineTo(pad.l + (i / (n - 1)) * cw, pad.t + ch - (tsData[i].active / maxY) * ch); }
            ctx.lineTo(pad.l + cw, pad.t + ch); ctx.closePath();
            const grad = ctx.createLinearGradient(0, pad.t, 0, pad.t + ch);
            grad.addColorStop(0, 'rgba(108,123,240,0.35)'); grad.addColorStop(1, 'rgba(108,123,240,0.02)');
            ctx.fillStyle = grad; ctx.fill();
            // line
            ctx.beginPath();
            for (let i = 0; i < n; i++) {
                const x = pad.l + (i / (n - 1)) * cw, y = pad.t + ch - (tsData[i].active / maxY) * ch;
                i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
            }
            ctx.strokeStyle = '#6c7bf0'; ctx.lineWidth = 2; ctx.lineJoin = 'round'; ctx.stroke();
            // latest dot
            const lx = pad.l + cw, ly = pad.t + ch - (tsData[n - 1].active / maxY) * ch;
            ctx.beginPath(); ctx.arc(lx, ly, 3, 0, Math.PI * 2); ctx.fillStyle = '#6c7bf0'; ctx.fill();
        }
        async function resetStats() { try { await fetch(B + '/stats/reset', { method: 'POST' }); poll(); toast(t('toast.stats_cleared')); } catch { toast(t('toast.clear_failed'), false); } }

        async function resetDbg() {
            try {
                await fetch(B + '/debug/bridge-calls/reset', { method: 'POST' });
                pollDbg();
                toast(t('toast.debug_cleared'));
            } catch {
                toast(t('toast.clear_failed'), false);
            }
        }
        async function fetchWithTimeout(url, ms, opt = {}) {
            const ac = new AbortController();
            const t = setTimeout(() => ac.abort(), ms);
            try {
                return await fetch(url, { ...opt, signal: ac.signal, cache: 'no-store' });
            } finally {
                clearTimeout(t);
            }
        }
        async function exitApp() {
            const btn = $('exitBtn');
            btn.disabled = true;
            btn.textContent = t('misc.shutting_down');
            try {
                await fetchWithTimeout(B + '/refresh?ts=' + Date.now(), 3000);
            } catch (_) {
                // expected timeout after 3s
            }
            try {
                await fetchWithTimeout(B + '/shutdown', 3000, { method: 'POST' });
            } catch (_) {
                // server may already be shutting down
            }
            window.close();
            setTimeout(() => { location.href = 'about:blank'; }, 200);
        }
        /* â•â• Config â•â• */
        const SCH = {
            sample_rate: { lk: 'cfg.sample_rate', t: 'number', gk: 'cfg.group.audio' },
            n_fft: { lk: 'cfg.n_fft', t: 'number', gk: 'cfg.group.audio' },
            win_size: { lk: 'cfg.win_size', t: 'number', gk: 'cfg.group.audio' },
            hop_size: { lk: 'cfg.hop_size', t: 'number', gk: 'cfg.group.audio' },
            hop_size_interp: { lk: 'cfg.hop_size_interp', t: 'number', gk: 'cfg.group.audio' },
            num_mels: { lk: 'cfg.num_mels', t: 'number', gk: 'cfg.group.audio' },
            fmin: { lk: 'cfg.fmin', t: 'number', s: .1, gk: 'cfg.group.audio' },
            fmax: { lk: 'cfg.fmax', t: 'number', s: .1, gk: 'cfg.group.audio' },
            pad_frames: { lk: 'cfg.pad_frames', t: 'number', gk: 'cfg.group.audio' },
            'vocoder.model': { lk: 'cfg.vocoder_model', t: 'text', gk: 'cfg.group.model' },
            'vocoder.model_type': { lk: 'cfg.vocoder_model_type', t: 'sel', o: ['onnx'], gk: 'cfg.group.model' },
            'vocoder.use_fp16': { lk: 'cfg.vocoder_use_fp16', t: 'bool', gk: 'cfg.group.model' },
            'hnsep.model': { lk: 'cfg.hnsep_model', t: 'text', gk: 'cfg.group.model' },
            'processing.wave_norm': { lk: 'cfg.wave_norm', t: 'bool', gk: 'cfg.group.processing' },
            'processing.wave_norm_clip_silence': { lk: 'cfg.wave_norm_clip', t: 'bool', gk: 'cfg.group.processing' },
            'processing.loop_mode': { lk: 'cfg.loop_mode', t: 'bool', gk: 'cfg.group.processing' },
            'processing.peak_limit': { lk: 'cfg.peak_limit', t: 'number', s: .01, gk: 'cfg.group.processing' },
            'performance.num_threads': { lk: 'cfg.num_threads', t: 'number', gk: 'cfg.group.performance' },
            'performance.device': { lk: 'cfg.device', t: 'sel', o: ['auto', 'cpu'], gk: 'cfg.group.performance' },
            'performance.device_id': { lk: 'cfg.device_id', t: 'number', gk: 'cfg.group.performance' },
            'server.host': { lk: 'cfg.host', t: 'text', gk: 'cfg.group.server' },
            'server.port': { lk: 'cfg.port', t: 'number', gk: 'cfg.group.server' },
        };
        function gv(o, p) { return p.split('.').reduce((a, k) => (a && a[k] !== undefined ? a[k] : ''), o); }
        function sv(o, p, v) { const ks = p.split('.'); let c = o; for (let i = 0; i < ks.length - 1; i++) { if (!c[ks[i]]) c[ks[i]] = {}; c = c[ks[i]]; } c[ks[ks.length - 1]] = v; }

        function normDevice(v) { return (v || '').toString().trim().toLowerCase(); }
        function availableDevices() {
            const ds = Array.isArray(caps.available_devices) ? caps.available_devices : ['auto', 'cpu'];
            return ds.map(normDevice).filter(Boolean);
        }
        function isDirectMLSelected() {
            const d = normDevice(gv(curCfg, 'performance.device'));
            return d === 'directml' || d === 'dml';
        }

        async function loadCaps() {
            try {
                const r = await fetch(B + '/capabilities', { cache: 'no-store' });
                if (!r.ok) throw new Error(await r.text());
                const d = await r.json();
                if (Array.isArray(d.available_devices) && d.available_devices.length) caps.available_devices = d.available_devices;
                caps.available_eps_raw = Array.isArray(d.available_eps_raw) ? d.available_eps_raw : [];
                caps.dml_adapters = Array.isArray(d.dml_adapters) ? d.dml_adapters : [];
            } catch {
                caps = { available_devices: ['auto', 'cpu'], available_eps_raw: [], dml_adapters: [] };
            }
        }

        async function loadCfg() {
            try { const r = await fetch(B + '/config'); curCfg = await r.json(); renderCfg(); } catch { toast(t('toast.load_cfg_failed'), false); }
        }
        function renderCfg() {
            const g = $('cfgGrid'), grps = {};
            const sch = JSON.parse(JSON.stringify(SCH));
            sch['performance.device'].o = availableDevices();

            for (const [p, s] of Object.entries(sch)) {
                if (p === 'performance.device_id' && !isDirectMLSelected()) continue;
                const gn = t(s.gk || 'cfg.group.other');
                if (!grps[gn]) grps[gn] = [];
                grps[gn].push({ p, ...s, l: t(s.lk), v: gv(curCfg, p) });
            }
            let h = '';
            for (const [gn, items] of Object.entries(grps)) {
                h += `<div class="cfg-hdr">${gn}</div>`;
                for (const it of items) {
                    h += `<div class="cfg-i"><span class="k" title="${it.p}">${it.l}</span>`;
                    if (it.t === 'bool') h += `<select data-p="${it.p}" class="ci"><option value="true" ${it.v ? 'selected' : ''}>${t('common.on')}</option><option value="false" ${!it.v ? 'selected' : ''}>${t('common.off')}</option></select>`;
                    else if (it.p === 'performance.device_id' && caps.dml_adapters && caps.dml_adapters.length) {
                        h += `<select data-p="${it.p}" class="ci">`;
                        for (const ad of caps.dml_adapters) {
                            const val = Number(ad.id);
                            const selected = Number(it.v) === val ? 'selected' : '';
                            h += `<option value="${val}" ${selected}>${ad.name || ('Adapter ' + val)} (#${val})</option>`;
                        }
                        h += '</select>';
                    }
                    else if (it.t === 'sel') { h += `<select data-p="${it.p}" class="ci">`; for (const o of it.o) h += `<option value="${o}" ${normDevice(it.v) === normDevice(o) ? 'selected' : ''}>${o}</option>`; h += '</select>'; }
                    else h += `<input data-p="${it.p}" class="ci" type="${it.t}" value="${it.v}" ${it.s ? 'step="' + it.s + '"' : ''}>`;

                    if (it.p === 'performance.device' && !availableDevices().includes(normDevice(it.v))) {
                        h += `<span style="color:var(--red);font-size:11px;">${t('cfg.device_unavailable')}</span>`;
                    }

                    h += '</div>';
                }
            }
            g.innerHTML = h;

            const devSel = document.querySelector('.ci[data-p="performance.device"]');
            if (devSel) {
                devSel.onchange = () => {
                    sv(curCfg, 'performance.device', devSel.value);
                    renderCfg();
                };
            }
        }
        async function saveCfg() {
            const cfg = JSON.parse(JSON.stringify(curCfg));
            document.querySelectorAll('.ci').forEach(el => {
                const p = el.dataset.p;
                const s = SCH[p] || {};
                let v = el.value;
                if (s.t === 'number' || p === 'performance.device_id') v = Number(v);
                else if (s.t === 'bool') v = v === 'true';
                sv(cfg, p, v);
            });

            const currentDevice = normDevice(gv(cfg, 'performance.device'));
            if (!availableDevices().includes(currentDevice)) {
                sv(cfg, 'performance.device', 'auto');
                toast(t('toast.device_fallback'), false);
            }

            try { const r = await fetch(B + '/config', { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(cfg) }); if (!r.ok) throw new Error(await r.text()); curCfg = cfg; toast(t('toast.cfg_saved')); } catch (e) { toast(t('toast.save_failed') + e.message, false); }
        }
        /* â•â• Setup â•â• */
        async function installBridge() {
            const p = $('ouPath').value.trim();
            if (!p) { toast(t('toast.enter_path'), false); return; }
            const st = $('instSt');
            st.innerHTML = `<div class="smsg in">${t('toast.installing')}</div>`;
            try {
                const r = await fetch(B + '/install-bridge', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ path: p }) });
                const j = await r.json();
                if (r.ok) { st.innerHTML = '<div class="smsg ok">âœ… ' + esc(String(j.message || '')) + '</div>'; toast(t('toast.install_ok')); }
                else { st.innerHTML = '<div class="smsg er">âŒ ' + esc(String(j.error || '')) + '</div>'; toast(t('toast.install_failed'), false); }
            } catch { st.innerHTML = `<div class="smsg er">âŒ ${t('toast.connect_failed')}</div>`; toast(t('toast.install_failed'), false); }
        }
        /* â”€â”€ init â”€â”€ */
        $('langSel').onchange = (e) => {
            LANG = SUPPORTED_LANGS.includes(e.target.value) ? e.target.value : 'zh';
            localStorage.setItem('hifisampler.lang', LANG);
            applyI18n();
        };
        applyI18n();
        poll(); pollDbg();
        loadCaps().then(loadCfg);
        setInterval(poll, 200);
        setInterval(pollDbg, 800);
    </script>
</body>

</html>
