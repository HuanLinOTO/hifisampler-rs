<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HiFiSampler Dashboard</title>
    <style>
        :root {
            --bg: #0f1117;
            --surface: #1a1d28;
            --surface2: #252836;
            --border: #2e3144;
            --text: #e4e6f0;
            --text-dim: #9ca0b4;
            --accent: #6c7bf0;
            --accent-hover: #8490f7;
            --green: #4ade80;
            --red: #f87171;
            --yellow: #fbbf24;
            --blue: #60a5fa;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* â”€â”€ Header â”€â”€ */
        .header {
            padding: 14px 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .header h1 {
            font-size: 18px;
            font-weight: 600;
            white-space: nowrap;
        }

        .header .status {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            color: var(--text-dim);
        }

        .header .status .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--green);
            animation: pulse 2s infinite;
        }

        .header .status .dot.off {
            background: var(--red);
            animation: none;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1
            }

            50% {
                opacity: .5
            }
        }

        .header .spacer {
            flex: 1;
        }

        .header .ver {
            font-size: 12px;
            color: var(--text-dim);
        }

        /* â”€â”€ Nav tabs â”€â”€ */
        .nav {
            display: flex;
            gap: 0;
            border-bottom: 1px solid var(--border);
            padding: 0 24px;
            overflow-x: auto;
        }

        .nav-t {
            padding: 11px 18px;
            cursor: pointer;
            font-size: 13px;
            color: var(--text-dim);
            border-bottom: 2px solid transparent;
            transition: all .2s;
            white-space: nowrap;
            user-select: none;
        }

        .nav-t.on {
            color: var(--accent);
            border-bottom-color: var(--accent);
        }

        .nav-t:hover:not(.on) {
            color: var(--text);
        }

        /* â”€â”€ Layout â”€â”€ */
        .main {
            padding: 20px 24px;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
        }

        .page {
            display: none;
            flex-direction: column;
            gap: 18px;
        }

        .page.on {
            display: flex;
        }

        /* â”€â”€ Cards â”€â”€ */
        .cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
        }

        .card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 16px;
            min-width: 0;
            overflow: hidden;
        }

        .card .lb {
            font-size: 11px;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: .5px;
        }

        .card .vl {
            font-size: 24px;
            font-weight: 700;
            margin-top: 6px;
            font-variant-numeric: tabular-nums;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .card .un {
            font-size: 13px;
            color: var(--text-dim);
            font-weight: 400;
        }

        /* â”€â”€ Section â”€â”€ */
        .sec {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 20px;
            overflow: hidden;
        }

        .sec h2 {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        /* â”€â”€ Time-series chart â”€â”€ */
        .chart-wrap {
            position: relative;
            height: 120px;
        }

        .chart-wrap canvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        /* (percentiles removed â€” now using canvas chart) */

        /* â”€â”€ Breakdown â”€â”€ */
        .bkd {
            display: flex;
            gap: 6px;
            margin-top: 12px;
        }

        .bkd .sg {
            height: 22px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 500;
            min-width: 48px;
        }

        .bkd .sg.f {
            background: #4f46e5;
        }

        .bkd .sg.s {
            background: #0891b2;
        }

        .bkd .sg.p {
            background: #059669;
        }

        .leg {
            display: flex;
            gap: 14px;
            margin-top: 6px;
            font-size: 11px;
            color: var(--text-dim);
            flex-wrap: wrap;
        }

        .leg i {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .leg d {
            width: 8px;
            height: 8px;
            border-radius: 2px;
            display: inline-block;
        }

        /* â”€â”€ Table â”€â”€ */
        .tw {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .rt {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        .rt th {
            text-align: left;
            padding: 6px 10px;
            color: var(--text-dim);
            font-weight: 500;
            border-bottom: 1px solid var(--border);
            white-space: nowrap;
        }

        .rt td {
            padding: 6px 10px;
            border-bottom: 1px solid var(--border);
            font-variant-numeric: tabular-nums;
            white-space: nowrap;
        }

        .rt td.args {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            white-space: pre-wrap;
            word-break: break-word;
            color: #d7dbef;
        }

        /* â”€â”€ Config form â”€â”€ */
        .cfg-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 10px;
        }

        .cfg-i {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            background: var(--surface2);
            border-radius: 6px;
            overflow: hidden;
            min-width: 0;
        }

        .cfg-i .k {
            color: var(--text-dim);
            font-size: 12px;
            white-space: nowrap;
            min-width: 110px;
            flex-shrink: 0;
        }

        .cfg-i input,
        .cfg-i select {
            flex: 1;
            min-width: 0;
            background: var(--bg);
            border: 1px solid var(--border);
            color: var(--text);
            padding: 5px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-family: inherit;
        }

        .cfg-i input:focus,
        .cfg-i select:focus {
            outline: none;
            border-color: var(--accent);
        }

        .cfg-hdr {
            grid-column: 1 / -1;
            font-size: 12px;
            color: var(--accent);
            font-weight: 600;
            margin-top: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* â”€â”€ Buttons â”€â”€ */
        .btn {
            padding: 7px 14px;
            border: 1px solid var(--border);
            background: var(--surface2);
            color: var(--text);
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all .2s;
            white-space: nowrap;
        }

        .btn:hover {
            background: var(--accent);
            border-color: var(--accent);
        }

        .btn-p {
            background: var(--accent);
            border-color: var(--accent);
        }

        .btn-p:hover {
            background: var(--accent-hover);
            border-color: var(--accent-hover);
        }

        .btn-ok {
            color: var(--green);
            border-color: #1e5c3a;
        }

        .btn-ok:hover {
            background: #1e5c3a;
            color: #fff;
        }

        .btn-no {
            color: var(--red);
            border-color: #5c2020;
        }

        .btn-no:hover {
            background: #5c2020;
            color: #fff;
        }

        /* â”€â”€ Setup wizard â”€â”€ */
        .wiz {
            max-width: 640px;
        }

        .step {
            margin-bottom: 20px;
            padding: 16px;
            background: var(--surface2);
            border-radius: 8px;
        }

        .step-h {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .step-n {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--accent);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            font-weight: 700;
            flex-shrink: 0;
        }

        .step-t {
            font-size: 14px;
            font-weight: 600;
        }

        .step-b {
            font-size: 13px;
            color: var(--text-dim);
            line-height: 1.7;
        }

        .step-b code {
            background: var(--bg);
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 12px;
        }

        .path-in {
            width: 100%;
            background: var(--bg);
            border: 1px solid var(--border);
            color: var(--text);
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 13px;
            margin-top: 8px;
            font-family: Consolas, monospace;
        }

        .path-in:focus {
            outline: none;
            border-color: var(--accent);
        }

        .smsg {
            padding: 10px 14px;
            border-radius: 6px;
            font-size: 13px;
            margin-top: 10px;
        }

        .smsg.ok {
            background: #132e1f;
            color: var(--green);
            border: 1px solid #1e5c3a;
        }

        .smsg.er {
            background: #2e1313;
            color: var(--red);
            border: 1px solid #5c2020;
        }

        .smsg.in {
            background: #131f2e;
            color: var(--blue);
            border: 1px solid #1e3a5c;
        }

        /* â”€â”€ Toast â”€â”€ */
        .toasts {
            position: fixed;
            top: 16px;
            right: 16px;
            z-index: 999;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .toast {
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 13px;
            animation: sIn .3s;
            box-shadow: 0 4px 12px rgba(0, 0, 0, .5);
        }

        .toast.s {
            background: #132e1f;
            color: var(--green);
            border: 1px solid #1e5c3a;
        }

        .toast.e {
            background: #2e1313;
            color: var(--red);
            border: 1px solid #5c2020;
        }

        @keyframes sIn {
            from {
                transform: translateX(100%);
                opacity: 0
            }

            to {
                transform: translateX(0);
                opacity: 1
            }
        }

        @media (max-width:640px) {
            .header {
                padding: 12px 16px
            }

            .nav {
                padding: 0 16px
            }

            .main {
                padding: 16px
            }

            .cards {
                grid-template-columns: repeat(2, 1fr)
            }

            .cfg-grid {
                grid-template-columns: 1fr
            }
        }
    </style>
</head>

<body>
    <div class="toasts" id="toasts"></div>
    <div class="header">
        <h1>ğŸµ HiFiSampler</h1>
        <div class="status">
            <div class="dot" id="sd"></div><span id="st">è¿æ¥ä¸­â€¦</span>
        </div>
        <div class="spacer"></div>
        <button class="btn btn-no" id="exitBtn" onclick="exitApp()">é€€å‡º</button>
        <div class="ver">v0.1.0</div>
    </div>
    <div class="nav">
        <div class="nav-t on" data-p="mon">ğŸ“Š ç›‘æ§é¢æ¿</div>
        <div class="nav-t" data-p="cfg">âš™ é…ç½®ç®¡ç†</div>
        <div class="nav-t" data-p="set">ğŸ”§ å®‰è£…å‘å¯¼</div>
    </div>
    <div class="main">
        <!-- â•â• Monitor â•â• -->
        <div class="page on" id="p-mon">
            <div class="cards">
                <div class="card">
                    <div class="lb">æ€»è¯·æ±‚æ•°</div>
                    <div class="vl" id="c-req">0</div>
                </div>
                <div class="card">
                    <div class="lb">å¹³å‡å»¶è¿Ÿ</div>
                    <div class="vl" id="c-avg">0<span class="un">ms</span></div>
                </div>
                <div class="card">
                    <div class="lb">P95 å»¶è¿Ÿ</div>
                    <div class="vl" id="c-p95">0<span class="un">ms</span></div>
                </div>
                <div class="card">
                    <div class="lb">ç¼“å­˜å‘½ä¸­ç‡</div>
                    <div class="vl" id="c-hit">0<span class="un">%</span></div>
                </div>
                <div class="card">
                    <div class="lb">ååé‡</div>
                    <div class="vl" id="c-rps">0<span class="un">rps</span></div>
                </div>
                <div class="card">
                    <div class="lb">é”™è¯¯</div>
                    <div class="vl" id="c-err">0</div>
                </div>
            </div>
            <div class="sec">
                <h2>ğŸ“ˆ è¯·æ±‚æ´»åŠ¨</h2>
                <div class="chart-wrap">
                    <canvas id="chart"></canvas>
                </div>
            </div>
            <div class="sec">
                <h2>ğŸ“Š è€—æ—¶åˆ†å¸ƒ (å¹³å‡)</h2>
                <div class="bkd" id="bkd"></div>
                <div class="leg">
                    <i>
                        <d style="background:#4f46e5"></d> ç‰¹å¾æå–
                    </i>
                    <i>
                        <d style="background:#0891b2"></d> åˆæˆ
                    </i>
                    <i>
                        <d style="background:#059669"></d> åå¤„ç†
                    </i>
                </div>
            </div>
            <div class="sec">
                <h2>ğŸ“‹ æœ€è¿‘è¯·æ±‚ <div style="flex:1"></div> <button class="btn" onclick="resetStats()">æ¸…ç©ºç»Ÿè®¡</button></h2>
                <div class="tw">
                    <table class="rt">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>æ€»è®¡(ms)</th>
                                <th>ç‰¹å¾</th>
                                <th>åˆæˆ</th>
                                <th>åå¤„ç†</th>
                                <th>é‡‡æ ·æ•°</th>
                                <th>ç¼“å­˜</th>
                            </tr>
                        </thead>
                        <tbody id="tbody"></tbody>
                    </table>
                </div>
            </div>

            <div class="sec">
                <h2>ğŸ› Bridge è°ƒç”¨å‚æ•° <div style="flex:1"></div> <button class="btn" onclick="resetDbg()">æ¸…ç©º</button></h2>
                <p style="font-size:12px;color:var(--text-dim);margin-bottom:12px;">æ˜¾ç¤ºæœ€è¿‘ 50 æ¬¡ bridge è°ƒç”¨ä¼ å…¥çš„åŸå§‹ CLI å‚æ•°ï¼ˆå³ POST / çš„ bodyï¼‰ï¼Œç”¨äºæ’æŸ¥ flags æ˜¯å¦çœŸçš„ä¼ åˆ°æœåŠ¡ç«¯ã€‚</p>
                <div class="tw">
                    <table class="rt">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>æ—¶é—´</th>
                                <th>æ¥æº</th>
                                <th>å‚æ•°</th>
                            </tr>
                        </thead>
                        <tbody id="dbgBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
        <!-- â•â• Config â•â• -->
        <div class="page" id="p-cfg">
            <div class="sec">
                <h2>âš™ è¿è¡Œæ—¶é…ç½®
                    <div style="flex:1"></div>
                    <button class="btn btn-p" onclick="saveCfg()">ğŸ’¾ ä¿å­˜é…ç½®</button>
                    <button class="btn" onclick="loadCfg()">ğŸ”„ é‡ç½®</button>
                </h2>
                <p style="font-size:12px;color:var(--text-dim);margin-bottom:14px;">ä¿®æ”¹é…ç½®åç‚¹å‡»ã€Œä¿å­˜é…ç½®ã€å°†å†™å…¥
                    config.yamlã€‚éƒ¨åˆ†è®¾ç½®éœ€è¦é‡å¯æœåŠ¡æ‰èƒ½ç”Ÿæ•ˆã€‚</p>
                <div class="cfg-grid" id="cfgGrid"></div>
            </div>
        </div>
        <!-- â•â• Setup â•â• -->
        <div class="page" id="p-set">
            <div class="sec wiz">
                <h2>ğŸ”§ OpenUTAU å®‰è£…å‘å¯¼</h2>
                <p style="font-size:13px;color:var(--text-dim);margin-bottom:16px;">å°† HiFiSampler æ¡¥æ¥ç¨‹åºå®‰è£…åˆ° OpenUTAUï¼Œåªéœ€ 3
                    æ­¥ã€‚</p>
                <div class="step">
                    <div class="step-h">
                        <div class="step-n">1</div>
                        <div class="step-t">é€‰æ‹© OpenUTAU Resamplers ç›®å½•</div>
                    </div>
                    <div class="step-b">
                        <p>æ‰“å¼€ OpenUTAU å®‰è£…ç›®å½•ï¼Œæ‰¾åˆ° <code>Resamplers</code> æ–‡ä»¶å¤¹ã€‚</p>
                        <p>é€šå¸¸ä½äºï¼š<code>C:\Users\ä½ çš„ç”¨æˆ·å\OpenUtau\Resamplers</code></p>
                        <p>æˆ– OpenUTAU ç¨‹åºæ‰€åœ¨ç›®å½•ä¸‹çš„ <code>Resamplers</code> æ–‡ä»¶å¤¹ã€‚</p>
                        <input class="path-in" id="ouPath" placeholder="è¾“å…¥æˆ–ç²˜è´´ Resamplers æ–‡ä»¶å¤¹çš„å®Œæ•´è·¯å¾„">
                    </div>
                </div>
                <div class="step">
                    <div class="step-h">
                        <div class="step-n">2</div>
                        <div class="step-t">å®‰è£…æ¡¥æ¥ç¨‹åº</div>
                    </div>
                    <div class="step-b">
                        <p>ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ï¼Œå°† <code>hifisampler.exe</code> å¤åˆ¶åˆ° Resamplers ç›®å½•ã€‚</p>
                        <button class="btn btn-ok" onclick="installBridge()">ğŸ“¦ å®‰è£…æ¡¥æ¥ç¨‹åº</button>
                        <div id="instSt"></div>
                    </div>
                </div>
                <div class="step">
                    <div class="step-h">
                        <div class="step-n">3</div>
                        <div class="step-t">é…ç½® OpenUTAU</div>
                    </div>
                    <div class="step-b">
                        <ol style="padding-left:18px;line-height:2">
                            <li><strong>é‡å¯ OpenUTAU</strong></li>
                            <li>åˆ‡æ¢åˆ° <strong>Classic æ¨¡å¼</strong></li>
                            <li>ç‚¹å‡»å³ä¸Šè§’ <strong>ğŸ”§ æ‰³æ‰‹æŒ‰é’®</strong></li>
                            <li>åœ¨ Resampler ä¸‹æ‹‰åˆ—è¡¨ä¸­é€‰æ‹© <code>hifisampler.exe</code></li>
                            <li>å®Œæˆï¼äº«å— HiFi éŸ³è´¨çš„ UTAU åˆæˆ ğŸ‰</li>
                        </ol>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        const B = location.origin;
        let curCfg = {};
        /* â”€â”€ tabs â”€â”€ */
        document.querySelectorAll('.nav-t').forEach(t => t.onclick = () => {
            document.querySelectorAll('.nav-t').forEach(x => x.classList.remove('on'));
            document.querySelectorAll('.page').forEach(x => x.classList.remove('on'));
            t.classList.add('on');
            document.getElementById('p-' + t.dataset.p).classList.add('on');
        });
        /* â”€â”€ toast â”€â”€ */
        function toast(m, ok = true) {
            const c = document.getElementById('toasts'), d = document.createElement('div');
            d.className = 'toast ' + (ok ? 's' : 'e'); d.textContent = m; c.appendChild(d);
            setTimeout(() => { d.style.opacity = '0'; setTimeout(() => d.remove(), 300); }, 3000);
        }
        /* â•â• Monitor â•â• */
        async function poll() {
            try {
                const r = await fetch(B + '/stats');
                if (!r.ok) throw 0;
                const d = await r.json();
                upMon(d); setOn(true);
            } catch { setOn(false); }
        }

        async function pollDbg() {
            try {
                const r = await fetch(B + '/debug/bridge-calls', { cache: 'no-store' });
                if (!r.ok) throw 0;
                const d = await r.json();
                upDbg(d);
            } catch {
                // ignore
            }
        }
        function setOn(v) { document.getElementById('sd').className = v ? 'dot' : 'dot off'; document.getElementById('st').textContent = v ? 'åœ¨çº¿' : 'ç¦»çº¿'; }
        function $(id) { return document.getElementById(id); }

        function fmtTs(ms) {
            const dt = new Date(ms);
            const pad = (n) => String(n).padStart(2, '0');
            return pad(dt.getHours()) + ':' + pad(dt.getMinutes()) + ':' + pad(dt.getSeconds());
        }

        function esc(s) {
            return (s ?? '').toString()
                .replaceAll('&', '&amp;')
                .replaceAll('<', '&lt;')
                .replaceAll('>', '&gt;')
                .replaceAll('"', '&quot;')
                .replaceAll("'", '&#39;');
        }

        function upDbg(d) {
            const tb = $('dbgBody');
            if (!tb) return;
            if (!d || !d.length) {
                tb.innerHTML = '<tr><td colspan="4" style="color:var(--text-dim);text-align:center">æš‚æ— è®°å½•</td></tr>';
                return;
            }
            tb.innerHTML = d.map((r, i) => {
                const args = esc(r.args || '');
                const remote = esc(r.remote || '');
                const ts = fmtTs(r.unix_ms || 0);
                return `<tr><td>${i + 1}</td><td>${ts}</td><td>${remote}</td><td class="args">${args}</td></tr>`;
            }).join('');
        }
        /* â”€â”€ time-series data â”€â”€ */
        const TS_MAX = 150; // 150 points Ã— 0.2s = 30s window
        const tsData = [];  // [{t: Date, active: number}]
        function upMon(d) {
            $('c-req').textContent = d.total_requests;
            $('c-avg').innerHTML = d.avg_total_ms.toFixed(1) + '<span class="un">ms</span>';
            $('c-p95').innerHTML = d.p95_total_ms.toFixed(1) + '<span class="un">ms</span>';
            $('c-hit').innerHTML = (d.cache_hit_rate * 100).toFixed(0) + '<span class="un">%</span>';
            $('c-rps').innerHTML = d.throughput_rps.toFixed(1) + '<span class="un">rps</span>';
            $('c-err').textContent = d.total_errors;
            /* time-series: record active requests */
            tsData.push({ t: new Date(), active: d.active_requests || 0 });
            while (tsData.length > TS_MAX) tsData.shift();
            drawChart();
            /* breakdown */
            const bd = $('bkd'), t = d.avg_feature_ms + d.avg_synthesis_ms + d.avg_postprocess_ms;
            if (t <= 0) { bd.innerHTML = '<div style="color:var(--text-dim);font-size:12px">æš‚æ— æ•°æ®</div>'; }
            else { const fp = (d.avg_feature_ms / t * 100).toFixed(0), sp = (d.avg_synthesis_ms / t * 100).toFixed(0), pp = (d.avg_postprocess_ms / t * 100).toFixed(0); bd.innerHTML = `<div class="sg f" style="flex:${fp}">${d.avg_feature_ms.toFixed(0)}ms (${fp}%)</div><div class="sg s" style="flex:${sp}">${d.avg_synthesis_ms.toFixed(0)}ms (${sp}%)</div><div class="sg p" style="flex:${pp}">${d.avg_postprocess_ms.toFixed(0)}ms (${pp}%)</div>`; }
            /* table */
            const rc = d.recent, tb = $('tbody');
            if (!rc || !rc.length) { tb.innerHTML = '<tr><td colspan="7" style="color:var(--text-dim);text-align:center">æš‚æ— è¯·æ±‚</td></tr>'; }
            else { tb.innerHTML = rc.map((r, i) => `<tr><td>${i + 1}</td><td>${r.total_ms.toFixed(1)}</td><td>${r.feature_ms.toFixed(1)}</td><td>${r.synthesis_ms.toFixed(1)}</td><td>${r.postprocess_ms.toFixed(1)}</td><td>${r.output_samples}</td><td>${r.cache_hit ? 'âœ“' : 'âœ—'}</td></tr>`).join(''); }
        }
        /* â”€â”€ canvas chart â”€â”€ */
        function drawChart() {
            const canvas = $('chart');
            const rect = canvas.parentElement.getBoundingClientRect();
            const dpr = window.devicePixelRatio || 1;
            const W = rect.width, H = rect.height;
            canvas.width = W * dpr; canvas.height = H * dpr;
            const ctx = canvas.getContext('2d');
            ctx.scale(dpr, dpr);
            const pad = { l: 36, r: 12, t: 12, b: 24 };
            const cw = W - pad.l - pad.r, ch = H - pad.t - pad.b;
            ctx.clearRect(0, 0, W, H);
            if (tsData.length < 2) {
                ctx.fillStyle = '#9ca0b4'; ctx.font = '12px sans-serif'; ctx.textAlign = 'center';
                ctx.fillText('ç­‰å¾…æ•°æ®â€¦', W / 2, H / 2);
                return;
            }
            const maxY = Math.max(1, ...tsData.map(p => p.active));
            const yTicks = Math.min(maxY, 5);
            // grid & Y labels
            ctx.strokeStyle = '#2e3144'; ctx.lineWidth = 1;
            ctx.fillStyle = '#9ca0b4'; ctx.font = '10px sans-serif'; ctx.textAlign = 'right';
            for (let i = 0; i <= yTicks; i++) {
                const v = Math.round(maxY / yTicks * i);
                const y = pad.t + ch - (v / maxY) * ch;
                ctx.beginPath(); ctx.moveTo(pad.l, y); ctx.lineTo(pad.l + cw, y); ctx.stroke();
                ctx.fillText(v, pad.l - 4, y + 3);
            }
            // X labels (~5)
            ctx.textAlign = 'center';
            const n = tsData.length, xStep = Math.max(1, Math.floor(n / 5));
            for (let i = 0; i < n; i += xStep) {
                const x = pad.l + (i / (n - 1)) * cw;
                const tt = tsData[i].t;
                const lbl = tt.getHours().toString().padStart(2, '0') + ':' + tt.getMinutes().toString().padStart(2, '0') + ':' + tt.getSeconds().toString().padStart(2, '0');
                ctx.fillText(lbl, x, H - 4);
            }
            // area fill
            ctx.beginPath(); ctx.moveTo(pad.l, pad.t + ch);
            for (let i = 0; i < n; i++) { ctx.lineTo(pad.l + (i / (n - 1)) * cw, pad.t + ch - (tsData[i].active / maxY) * ch); }
            ctx.lineTo(pad.l + cw, pad.t + ch); ctx.closePath();
            const grad = ctx.createLinearGradient(0, pad.t, 0, pad.t + ch);
            grad.addColorStop(0, 'rgba(108,123,240,0.35)'); grad.addColorStop(1, 'rgba(108,123,240,0.02)');
            ctx.fillStyle = grad; ctx.fill();
            // line
            ctx.beginPath();
            for (let i = 0; i < n; i++) {
                const x = pad.l + (i / (n - 1)) * cw, y = pad.t + ch - (tsData[i].active / maxY) * ch;
                i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
            }
            ctx.strokeStyle = '#6c7bf0'; ctx.lineWidth = 2; ctx.lineJoin = 'round'; ctx.stroke();
            // latest dot
            const lx = pad.l + cw, ly = pad.t + ch - (tsData[n - 1].active / maxY) * ch;
            ctx.beginPath(); ctx.arc(lx, ly, 3, 0, Math.PI * 2); ctx.fillStyle = '#6c7bf0'; ctx.fill();
        }
        async function resetStats() { try { await fetch(B + '/stats/reset', { method: 'POST' }); poll(); toast('ç»Ÿè®¡å·²æ¸…ç©º'); } catch { toast('æ¸…ç©ºå¤±è´¥', false); } }

        async function resetDbg() {
            try {
                await fetch(B + '/debug/bridge-calls/reset', { method: 'POST' });
                pollDbg();
                toast('è°ƒè¯•è®°å½•å·²æ¸…ç©º');
            } catch {
                toast('æ¸…ç©ºå¤±è´¥', false);
            }
        }
        async function fetchWithTimeout(url, ms, opt = {}) {
            const ac = new AbortController();
            const t = setTimeout(() => ac.abort(), ms);
            try {
                return await fetch(url, { ...opt, signal: ac.signal, cache: 'no-store' });
            } finally {
                clearTimeout(t);
            }
        }
        async function exitApp() {
            const btn = $('exitBtn');
            btn.disabled = true;
            btn.textContent = 'é€€å‡ºä¸­...';
            try {
                await fetchWithTimeout(B + '/refresh?ts=' + Date.now(), 3000);
            } catch (_) {
                // expected timeout after 3s
            }
            try {
                await fetchWithTimeout(B + '/shutdown', 3000, { method: 'POST' });
            } catch (_) {
                // server may already be shutting down
            }
            window.close();
            setTimeout(() => { location.href = 'about:blank'; }, 200);
        }
        /* â•â• Config â•â• */
        const SCH = {
            sample_rate: { l: 'é‡‡æ ·ç‡', t: 'number', g: 'éŸ³é¢‘' },
            n_fft: { l: 'FFT å¤§å°', t: 'number', g: 'éŸ³é¢‘' },
            win_size: { l: 'çª—å£å¤§å°', t: 'number', g: 'éŸ³é¢‘' },
            hop_size: { l: 'Hop å¤§å°', t: 'number', g: 'éŸ³é¢‘' },
            hop_size_interp: { l: 'æ’å€¼ Hop', t: 'number', g: 'éŸ³é¢‘' },
            num_mels: { l: 'Mel é€šé“æ•°', t: 'number', g: 'éŸ³é¢‘' },
            fmin: { l: 'æœ€ä½é¢‘ç‡', t: 'number', s: .1, g: 'éŸ³é¢‘' },
            fmax: { l: 'æœ€é«˜é¢‘ç‡', t: 'number', s: .1, g: 'éŸ³é¢‘' },
            pad_frames: { l: 'å¡«å……å¸§æ•°', t: 'number', g: 'éŸ³é¢‘' },
            'vocoder.model': { l: 'Vocoder æ¨¡å‹è·¯å¾„', t: 'text', g: 'æ¨¡å‹' },
            'vocoder.model_type': { l: 'æ¨¡å‹ç±»å‹', t: 'sel', o: ['onnx'], g: 'æ¨¡å‹' },
            'hnsep.model': { l: 'HN-SEP æ¨¡å‹è·¯å¾„', t: 'text', g: 'æ¨¡å‹' },
            'processing.wave_norm': { l: 'æ³¢å½¢å½’ä¸€åŒ–', t: 'bool', g: 'å¤„ç†' },
            'processing.wave_norm_clip_silence': { l: 'è£å‰ªé™éŸ³', t: 'bool', g: 'å¤„ç†' },
            'processing.loop_mode': { l: 'å¾ªç¯æ¨¡å¼', t: 'bool', g: 'å¤„ç†' },
            'processing.peak_limit': { l: 'å³°å€¼é™åˆ¶', t: 'number', s: .01, g: 'å¤„ç†' },
            'performance.num_threads': { l: 'æ¨ç†çº¿ç¨‹æ•°', t: 'number', g: 'æ€§èƒ½' },
            'performance.device': { l: 'è®¾å¤‡', t: 'sel', o: ['auto', 'cpu', 'cuda', 'tensorrt', 'directml', 'coreml'], g: 'æ€§èƒ½' },
            'server.host': { l: 'æœåŠ¡åœ°å€', t: 'text', g: 'æœåŠ¡å™¨' },
            'server.port': { l: 'æœåŠ¡ç«¯å£', t: 'number', g: 'æœåŠ¡å™¨' },
        };
        function gv(o, p) { return p.split('.').reduce((a, k) => (a && a[k] !== undefined ? a[k] : ''), o); }
        function sv(o, p, v) { const ks = p.split('.'); let c = o; for (let i = 0; i < ks.length - 1; i++) { if (!c[ks[i]]) c[ks[i]] = {}; c = c[ks[i]]; } c[ks[ks.length - 1]] = v; }
        async function loadCfg() {
            try { const r = await fetch(B + '/config'); curCfg = await r.json(); renderCfg(); } catch { toast('åŠ è½½é…ç½®å¤±è´¥', false); }
        }
        function renderCfg() {
            const g = $('cfgGrid'), grps = {};
            for (const [p, s] of Object.entries(SCH)) { const gn = s.g || 'å…¶ä»–'; if (!grps[gn]) grps[gn] = []; grps[gn].push({ p, ...s, v: gv(curCfg, p) }); }
            let h = '';
            for (const [gn, items] of Object.entries(grps)) {
                h += `<div class="cfg-hdr">${gn}</div>`;
                for (const it of items) {
                    h += `<div class="cfg-i"><span class="k" title="${it.p}">${it.l}</span>`;
                    if (it.t === 'bool') h += `<select data-p="${it.p}" class="ci"><option value="true" ${it.v ? 'selected' : ''}>å¼€å¯</option><option value="false" ${!it.v ? 'selected' : ''}>å…³é—­</option></select>`;
                    else if (it.t === 'sel') { h += `<select data-p="${it.p}" class="ci">`; for (const o of it.o) h += `<option value="${o}" ${it.v === o ? 'selected' : ''}>${o}</option>`; h += '</select>'; }
                    else h += `<input data-p="${it.p}" class="ci" type="${it.t}" value="${it.v}" ${it.s ? 'step="' + it.s + '"' : ''}>`;
                    h += '</div>';
                }
            }
            g.innerHTML = h;
        }
        async function saveCfg() {
            const cfg = JSON.parse(JSON.stringify(curCfg));
            document.querySelectorAll('.ci').forEach(el => { const p = el.dataset.p, s = SCH[p]; let v = el.value; if (s.t === 'number') v = Number(v); else if (s.t === 'bool') v = v === 'true'; sv(cfg, p, v); });
            try { const r = await fetch(B + '/config', { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(cfg) }); if (!r.ok) throw new Error(await r.text()); curCfg = cfg; toast('é…ç½®å·²ä¿å­˜ï¼éƒ¨åˆ†è®¾ç½®é‡å¯åç”Ÿæ•ˆ'); } catch (e) { toast('ä¿å­˜å¤±è´¥: ' + e.message, false); }
        }
        /* â•â• Setup â•â• */
        async function installBridge() {
            const p = $('ouPath').value.trim();
            if (!p) { toast('è¯·å…ˆè¾“å…¥ Resamplers ç›®å½•è·¯å¾„', false); return; }
            const st = $('instSt');
            st.innerHTML = '<div class="smsg in">æ­£åœ¨å®‰è£…â€¦</div>';
            try {
                const r = await fetch(B + '/install-bridge', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ path: p }) });
                const j = await r.json();
                if (r.ok) { st.innerHTML = '<div class="smsg ok">âœ… ' + j.message + '</div>'; toast('æ¡¥æ¥ç¨‹åºå®‰è£…æˆåŠŸï¼'); }
                else { st.innerHTML = '<div class="smsg er">âŒ ' + j.error + '</div>'; toast('å®‰è£…å¤±è´¥', false); }
            } catch { st.innerHTML = '<div class="smsg er">âŒ è¿æ¥æœåŠ¡å™¨å¤±è´¥</div>'; toast('å®‰è£…å¤±è´¥', false); }
        }
        /* â”€â”€ init â”€â”€ */
        poll(); pollDbg(); loadCfg();
        setInterval(poll, 200);
        setInterval(pollDbg, 800);
    </script>
</body>

</html>
